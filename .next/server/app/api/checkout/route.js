"use strict";(()=>{var e={};e.id=607,e.ids=[607],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},799:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>p,PUT:()=>l});var a=r(9303),i=r(8716),o=r(670),n=r(7070),u=r(182);!function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}();let c=Object(function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}())(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"}),d={individual:{priceId:process.env.STRIPE_INDIVIDUAL_PRICE_ID||"price_individual_default",amount:4900,name:"Individual Plan",features:["Up to 5 users","Basic discrepancy detection","Email support","Standard integrations"]},pro:{priceId:process.env.STRIPE_PRO_PRICE_ID||"price_pro_default",amount:9900,name:"Pro Plan",features:["Up to 25 users","Advanced AI protection","Priority support","Custom workflows","Audit reporting"]},team:{priceId:process.env.STRIPE_TEAM_PRICE_ID||"price_team_default",amount:39900,name:"Team Plan",features:["Up to 100 users","Enterprise AI features","Dedicated support","Advanced integrations","SOC 2 compliance"]}};async function p(e){try{let t=(0,u.e)(),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{plan:a,successUrl:i,cancelUrl:o}=await e.json();if(!a||!d[a])return n.NextResponse.json({error:"Invalid plan selected"},{status:400});let p=d[a],l="",{data:_}=await t.from("profiles").select("stripe_customer_id").eq("id",r.id).single();_?.stripe_customer_id?l=_.stripe_customer_id:(l=(await c.customers.create({email:r.email,metadata:{supabase_user_id:r.id}})).id,await t.from("profiles").upsert({id:r.id,email:r.email,stripe_customer_id:l}));let m=await c.checkout.sessions.create({customer:l,payment_method_types:["card"],line_items:[{price:p.priceId,quantity:1}],mode:"subscription",success_url:i||"http://localhost:5000/dashboard?session_id={CHECKOUT_SESSION_ID}",cancel_url:o||"http://localhost:5000/pricing",allow_promotion_codes:!0,billing_address_collection:"required",metadata:{supabase_user_id:r.id,plan:a},subscription_data:{metadata:{supabase_user_id:r.id,plan:a}}}),f=crypto.randomUUID();return await t.from("audit_log").insert({causality_id:f,action:"checkout_initiated",details:{plan:a,sessionId:m.id,amount:p.amount,customerId:l},user_id:r.id}),n.NextResponse.json({sessionId:m.id,url:m.url,plan:p,causalityId:f})}catch(r){console.error("Checkout error:",r);let e=(0,u.e)(),{data:{user:t}}=await e.auth.getUser();return t&&await e.from("audit_log").insert({causality_id:crypto.randomUUID(),action:"checkout_error",details:{error:r instanceof Error?r.message:"Unknown error"},user_id:t.id}),n.NextResponse.json({error:"Failed to create checkout session"},{status:500})}}async function l(e){try{let{sessionId:t}=await e.json();if(!t)return n.NextResponse.json({error:"Session ID required"},{status:400});let r=(0,u.e)(),s=await c.checkout.sessions.retrieve(t);if("paid"===s.payment_status&&s.metadata?.supabase_user_id){let e=s.metadata.supabase_user_id,a=s.metadata.plan;return await r.from("profiles").upsert({id:e,subscription_status:"active",subscription_plan:a,stripe_subscription_id:s.subscription,updated_at:new Date().toISOString()}),await r.from("audit_log").insert({causality_id:crypto.randomUUID(),action:"subscription_activated",details:{plan:a,sessionId:t,subscriptionId:s.subscription,amount:s.amount_total},user_id:e}),n.NextResponse.json({success:!0,plan:a,subscriptionId:s.subscription})}return n.NextResponse.json({error:"Payment not completed"},{status:400})}catch(e){return console.error("Checkout confirmation error:",e),n.NextResponse.json({error:"Failed to confirm payment"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/checkout/route",pathname:"/api/checkout",filename:"route",bundlePath:"app/api/checkout/route"},resolvedPagePath:"/home/runner/work/Foldera_Final_AI/Foldera_Final_AI/app/api/checkout/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h}=_,I="/api/checkout/route";function x(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,9],()=>r(799));module.exports=s})();